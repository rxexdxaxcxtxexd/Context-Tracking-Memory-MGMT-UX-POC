# Code Context Guide

**File:** `.claude-code-context.md`
**Purpose:** Auto-generated technical snapshot of latest code changes
**Generated:** On every git commit + SessionEnd (if uncommitted changes)
**Status:** Active (Phase 2+)

---

## What is Code Context?

The **Code Context** file (`.claude-code-context.md`) is an auto-generated markdown file that provides a **technical snapshot** of your latest code changes.

**Think of it as:**
- üì∏ A snapshot of what just changed
- üîó A map of file dependencies
- ‚ö†Ô∏è An early warning system for risky changes
- ‚úÖ A checklist of tests to run

---

## Why Code Context?

While `claude-mem` provides **semantic understanding** ("why did we do this?"), Code Context provides **technical precision** ("which files changed, what are the dependencies?").

**Semantic (claude-mem):**
```bash
/mem-search why did we choose Redis?
‚Üí "Because we needed distributed caching with persistence"
```

**Technical (Code Context):**
```markdown
## Changed Files
- [M] cache/redis_client.py
- [+] cache/config.py
- [M] requirements.txt

## Dependencies
cache/redis_client.py imports:
- redis
- cache/config.py
```

**Both layers complement each other!**

---

## When It's Generated

### 1. On Every Git Commit (Primary)
```bash
git add .
git commit -m "Your message"
# ‚Üí Post-commit hook generates .claude-code-context.md
```

### 2. On Session End (If Uncommitted Changes)
```bash
# When you close Claude Code with uncommitted changes:
# ‚Üí SessionEnd hook generates context for workspace state
```

### 3. Manual Generation (Rare)
```bash
python scripts/generate_code_context.py
```

---

## File Location

**Project root:** `.claude-code-context.md`

**Gitignored:** Yes (listed in `.gitignore`)
**Why gitignored:** Auto-generated, specific to your local state

**To view:**
```bash
cat .claude-code-context.md          # Unix/Mac
type .claude-code-context.md         # Windows
```

---

## File Structure

### Complete Example

```markdown
# Code Context (Auto-generated)

**Last Updated:** 2025-12-15 20:23:18

## Last Commit

- **Hash:** `4aebaeed`
- **Branch:** `master`
- **Remote:** https://github.com/user/repo.git
- **Date:** 2025-12-15T20:22:51-06:00
- **Message:** Implement user authentication

## Changed Files (5)

- [+] `auth/login.py`
- [+] `auth/models.py`
- [M] `api/routes.py`
- [M] `tests/test_api.py`
- [M] `requirements.txt`

## High-Impact Changes

[!] api/routes.py (Impact: 85/100)
    Used by: 12 file(s)
    Used by: auth/login.py, dashboard/views.py, admin/api.py (+9 more)

[!] auth/models.py (Impact: 72/100)
    Used by: 8 file(s)
    Used by: auth/login.py, auth/middleware.py, api/serializers.py (+5 more)
    [!] No test file found -> Create tests/test_auth_models.py

## Dependencies

auth/login.py imports:
- auth/models.py
- api/routes.py
- utils/validators.py
- third_party: flask, bcrypt

api/routes.py imports:
- auth/models.py
- database/connection.py
- utils/response.py

## Test Recommendations

**Run these tests:**
- tests/test_api.py (modified)
- tests/test_routes.py (api/routes.py changed)

**Create these tests:**
- tests/test_auth_models.py (auth/models.py missing tests)
- tests/test_login.py (auth/login.py missing tests)

---

*This file is auto-generated by `scripts/generate_code_context.py`.*
*Do not edit manually - changes will be overwritten on next commit.*
```

---

## Section Breakdown

### 1. Metadata

```markdown
# Code Context (Auto-generated)
**Last Updated:** 2025-12-15 20:23:18
```

**Contains:**
- Title
- Timestamp of generation

**Use for:** Knowing when context was last refreshed

---

### 2. Last Commit

```markdown
## Last Commit
- **Hash:** `4aebaeed`
- **Branch:** `master`
- **Remote:** https://github.com/user/repo.git
- **Date:** 2025-12-15T20:22:51-06:00
- **Message:** Implement user authentication
```

**Contains:**
- Git commit hash (short form)
- Branch name
- Remote repository URL
- Commit timestamp
- Commit message

**Use for:**
- Verifying which commit this context represents
- Cross-referencing with git history
- Understanding commit scope

---

### 3. Changed Files

```markdown
## Changed Files (5)
- [+] `auth/login.py`
- [M] `api/routes.py`
```

**Symbols:**
- `[+]` - Created (new file)
- `[M]` - Modified (existing file changed)
- `[-]` - Deleted (file removed)

**Contains:**
- All files changed in commit
- Action type for each file
- Count of total changes

**Use for:**
- Quick overview of scope
- Identifying which areas of codebase were touched

---

### 4. High-Impact Changes (Critical!)

```markdown
## High-Impact Changes

[!] api/routes.py (Impact: 85/100)
    Used by: 12 file(s)
    Used by: auth/login.py, dashboard/views.py, admin/api.py (+9 more)

[!] auth/models.py (Impact: 72/100)
    Used by: 8 file(s)
    [!] No test file found -> Create tests/test_auth_models.py
```

**Impact Score:** 0-100 (based on how many files import/use this file)
- `0-49`: Low impact (few dependencies)
- `50-69`: Medium impact (some dependencies)
- `70-100`: High impact (many dependencies - **be careful!**)

**Warnings:**
- `[!]` marks high-impact files (score >= 70)
- `[!] No test file found` warns about missing tests

**Contains:**
- Impact score for each high-impact file
- List of files that depend on it (top 10)
- Missing test file warnings

**Use for:**
- ‚ö†Ô∏è **Identifying risky changes** - high-impact files need extra care
- ‚úÖ **Prioritizing testing** - test high-impact files thoroughly
- üìù **Detecting missing tests** - create tests for uncovered files

**Example workflow:**
```markdown
[!] payment_processor.py (Impact: 92/100)
    Used by: 15 file(s)
    [!] No test file found

‚Üí Action: Create tests/test_payment_processor.py immediately!
‚Üí Action: Run all 15 dependent test files
```

---

### 5. Dependencies

```markdown
## Dependencies

auth/login.py imports:
- auth/models.py
- api/routes.py
- utils/validators.py
- third_party: flask, bcrypt
```

**Contains:**
- Import relationships for changed files
- Both internal (project files) and third-party (libraries)
- Shows what each file depends on

**Use for:**
- Understanding coupling between files
- Identifying circular dependencies
- Planning refactoring
- Debugging import errors

**How it's generated:**
Uses AST (Abstract Syntax Tree) parsing to extract actual import statements from Python files.

---

### 6. Test Recommendations

```markdown
## Test Recommendations

**Run these tests:**
- tests/test_api.py (modified)
- tests/test_routes.py (api/routes.py changed)

**Create these tests:**
- tests/test_auth_models.py (auth/models.py missing tests)
```

**Contains:**
- Tests that should be run (because related files changed)
- Tests that should be created (missing test coverage)

**Use for:**
- ‚úÖ Checklist before committing
- üìã Test planning
- üéØ Targeted testing (don't run entire suite)

**How it works:**
1. Detects changed files
2. Looks for corresponding test files (e.g., `foo.py` ‚Üí `test_foo.py`)
3. If test exists: Recommend running it
4. If test missing: Recommend creating it

---

## Viewing Code Context

### Method 1: CLI
```bash
# View entire file
cat .claude-code-context.md

# View just high-impact warnings
grep -A 3 "\[!\]" .claude-code-context.md

# View just test recommendations
sed -n '/## Test Recommendations/,/##/p' .claude-code-context.md
```

### Method 2: In Claude Code
Just reference the file in conversation:
```
Can you read .claude-code-context.md and tell me which tests I should run?
```

### Method 3: SessionStart Hook
Automatically displayed when you start Claude Code (brief summary).

---

## Practical Use Cases

### 1. Before Code Review
```bash
# Check what changed and impact
cat .claude-code-context.md

# Verify high-impact files have tests
# Create missing tests if needed
```

### 2. After Committing
```bash
# Automatically generated - review warnings
cat .claude-code-context.md

# Pay attention to [!] markers
```

### 3. Debugging Import Errors
```markdown
## Dependencies
foo.py imports:
- bar.py  # ‚Üê Is this causing circular import?
- baz.py
```

### 4. Planning Refactoring
```markdown
[!] utils.py (Impact: 95/100)
    Used by: 18 file(s)

‚Üí This file is central to the codebase
‚Üí Refactoring it will affect 18 other files
‚Üí Proceed carefully!
```

### 5. Test Prioritization
```markdown
## Test Recommendations
**Run these tests:**
- test_payment.py (payment.py changed)
- test_api.py (api.py changed)

‚Üí Run these 2 tests instead of entire suite (faster feedback)
```

---

## Configuration

### Location
`scripts/generate_code_context.py`

### Customization Options

#### Skip Non-Code Files
By default, only analyzes `.py` files. To add more:

```python
# In generate_code_context.py:
CODE_FILE_EXTENSIONS = ['.py', '.js', '.ts', '.java']
```

#### Impact Score Threshold
Change high-impact threshold (default: 70):

```python
# In generate_code_context.py:
HIGH_IMPACT_THRESHOLD = 70  # Adjust this
```

#### Dependency Cache TTL
Adjust cache invalidation time (default: 24 hours):

```python
# In dependency_analyzer.py:
CACHE_TTL_HOURS = 24  # Adjust this
```

---

## Performance

### Generation Speed
- **Typical commit (10-20 files):** <2 seconds
- **Large commit (50+ files):** 3-5 seconds
- **Very large commit (100+ files):** 5-10 seconds

### Caching
**Dependency analysis uses intelligent caching:**
- **Cache hit rate:** 75-85% (only analyzes modified files)
- **Cache key:** File path + modification time (mtime)
- **Invalidation:** Automatic when file changes

### Optimization
If generation is slow (rare):
1. Check for very large commits (>100 files)
2. Verify cache is working (`~/.claude/dependency-cache/`)
3. Consider splitting into smaller commits

---

## Troubleshooting

### Context file not generated after commit

**Check:**
1. Post-commit hook installed: `ls .git/hooks/post-commit`
2. Hook executable: `chmod +x .git/hooks/post-commit` (Unix)
3. Check for errors: Review commit output

**Solution:**
```bash
# Reinstall hooks
python scripts/install-hooks.py

# Manual generation
python scripts/generate_code_context.py
```

### High-impact warnings for small files

**Explanation:** Impact score is based on **usage**, not file size. A small utility file used everywhere has high impact.

**Example:**
```python
# utils.py (10 lines, but used by 20 files)
def format_date(date):
    return date.strftime('%Y-%m-%d')

# ‚Üí Impact: 90/100 (used by many files)
```

### Missing test recommendations for non-Python files

**Explanation:** Currently only analyzes Python files. Extend `generate_code_context.py` for other languages.

### Dependencies not showing third-party libraries

**Explanation:** Only shows direct imports. Transitive dependencies not tracked.

---

## Best Practices

### 1. Review After Every Commit
Make it a habit:
```bash
git commit -m "message"
cat .claude-code-context.md  # Review warnings
```

### 2. Pay Attention to [!] Markers
```markdown
[!] = High-impact change or missing test
‚Üí Requires extra attention!
```

### 3. Create Tests for High-Impact Files
```markdown
[!] No test file found for high_impact.py

‚Üí Priority: Create test_high_impact.py before merging
```

### 4. Use for Code Review Checklists
```markdown
Before requesting review:
- ‚úÖ Reviewed code context
- ‚úÖ Ran recommended tests
- ‚úÖ Created missing tests
- ‚úÖ No high-impact files without tests
```

### 5. Reference in Conversations
```
"Can you review .claude-code-context.md and suggest which areas need more testing?"
```

---

## Combining with claude-mem

**Code Context** and **claude-mem** work together:

| Question | Use |
|----------|-----|
| "Which files changed?" | Code Context |
| "Why did we change them?" | claude-mem (/mem-search) |
| "What are the dependencies?" | Code Context |
| "What was the architectural decision?" | claude-mem (/mem-search) |
| "What tests should I run?" | Code Context |
| "What was the bug fix strategy?" | claude-mem (/mem-search) |

**Workflow:**
1. **Commit code** ‚Üí Code Context generated
2. **Review technical details** ‚Üí Read .claude-code-context.md
3. **Search semantic context** ‚Üí /mem-search for "why"
4. **Run tests** ‚Üí Follow test recommendations
5. **Code review** ‚Üí Reference both sources

---

## FAQ

### Q: Can I edit .claude-code-context.md?
**A:** You can, but changes will be overwritten on next commit. Not recommended.

### Q: Why is it gitignored?
**A:** It's auto-generated and specific to your local state. Each developer should generate their own.

### Q: Can I commit it?
**A:** You could remove from .gitignore, but not recommended. It will create merge conflicts and is redundant with git history.

### Q: How accurate is the impact score?
**A:** Very accurate for Python files. Based on actual AST analysis of imports. For other languages, not supported yet.

### Q: Can I generate for uncommitted changes?
**A:** Yes! SessionEnd hook does this automatically. Or run manually:
```bash
python scripts/generate_code_context.py --workspace
```

### Q: Does it work for other languages besides Python?
**A:** Currently only Python. Extend `dependency_analyzer.py` for other languages.

### Q: What if I don't want dependency analysis?
**A:** It's fast (<2s), but you can disable by editing `post-commit-handler.py` to skip the generate_code_context call.

---

## Resources

- **Architecture:** See `docs/ARCHITECTURE.md` for system design
- **claude-mem Guide:** See `docs/CLAUDE_MEM_GUIDE.md` for semantic search
- **Migration:** See `docs/MIGRATION_GUIDE.md` for old ‚Üí new workflow
- **Session Protocol:** See `SESSION_PROTOCOL.md` for complete workflow

---

**Last Updated:** 2025-12-15
**Generator:** `scripts/generate_code_context.py`
**Dependency Analyzer:** `scripts/dependency_analyzer.py`
